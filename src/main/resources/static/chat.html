<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .login-form {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .chat-container {
        border: 1px solid #ccc;
        height: 400px;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
      }
      .message {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
      }
      .user-message {
        background-color: #e3f2fd;
        text-align: right;
      }
      .ai-message {
        background-color: #f3e5f5;
      }
      .support-message {
        background-color: #e8f5e8;
      }
      .system-message {
        background-color: #fff3e0;
        font-style: italic;
        text-align: center;
      }
      .error-message {
        background-color: #ffebee;
        color: #c62828;
      }
      .form-message {
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        font-size: 14px;
      }
      .form-message h4 {
        margin: 0 0 10px 0;
        color: #1976d2;
        font-size: 16px;
      }
      .form-message p {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 13px;
      }
      .form-row {
        display: flex;
        gap: 10px;
        align-items: end;
      }
      .form-group {
        flex: 1;
      }
      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      .update-info-btn {
        background-color: #2196f3;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
      }
      .update-info-btn:hover {
        background-color: #1976d2;
      }
      .input-container {
        display: flex;
        gap: 10px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        padding: 10px 20px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #1976d2;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .status {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .status.connected {
        background-color: #4caf50;
        color: white;
      }
      .status.disconnected {
        background-color: #f44336;
        color: white;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Chat Interface -->
    <div id="chatInterface">
      <div class="header">
        <h1>AI Chat</h1>
      </div>

      <div id="connectionStatus" class="status disconnected">Disconnected</div>

      <div class="chat-container" id="chatContainer">
        <div id="chatMessages" class="chat-messages"></div>
      </div>

      <div class="input-container">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          disabled
        />
        <button id="sendButton" onclick="sendMessage()" disabled>Send</button>
      </div>

      <div style="margin-top: 10px">
        <label for="categorySelect">Category (optional):</label>
        <select id="categorySelect">
          <option value="">Select a category...</option>
        </select>
        <button
          onclick="escalateToSupport()"
          style="margin-left: 10px; background-color: #ff9800"
        >
          Escalate to Support
        </button>
      </div>
    </div>

    <script>
      let stompClient = null;
      let chatId = null;

      function connect() {
        const socket = new SockJS("/ws/chat");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
          console.log("Connected: " + frame);
          updateConnectionStatus("Connected", "connected");

          // Show customer info form when connected
          showCustomerInfoForm();

          stompClient.subscribe("/topic/chat", function (message) {
            const messageData = JSON.parse(message.body);
            console.log("Received message:", messageData);
            displayMessage(messageData);
          });
        });
      }

      function updateConnectionStatus(message, className) {
        const statusDiv = document.getElementById("connectionStatus");
        statusDiv.textContent = message;
        statusDiv.className = "status " + className;
      }

      function showCustomerInfoForm() {
        const chatMessages = document.getElementById("chatMessages");

        // Check if form already exists
        if (document.getElementById("customerInfoForm")) {
          return;
        }

        const formDiv = document.createElement("div");
        formDiv.id = "customerInfoForm";
        formDiv.className = "message form-message";

        formDiv.innerHTML = `
          <h4>Contact Information (Optional)</h4>
          <p>Help us assist you better by providing your contact details:</p>
          <div class="form-row">
            <div class="form-group">
              <input
                type="text"
                id="customerName"
                placeholder="Your name (optional)"
              />
            </div>
            <div class="form-group">
              <input
                type="email"
                id="customerEmail"
                placeholder="your.email@example.com (optional)"
              />
            </div>
            <button onclick="updateCustomerInfo()" class="update-info-btn">
              Update Info
            </button>
          </div>
        `;

        chatMessages.appendChild(formDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateCustomerInfo() {
        const customerName = document
          .getElementById("customerName")
          .value.trim();
        const customerEmail = document
          .getElementById("customerEmail")
          .value.trim();

        // Store customer info for future messages
        window.customerName = customerName;
        window.customerEmail = customerEmail;

        // Show success message
        const form = document.getElementById("customerInfoForm");
        const successMsg = document.createElement("div");
        successMsg.style.color = "#4caf50";
        successMsg.style.fontSize = "12px";
        successMsg.style.marginTop = "5px";
        successMsg.textContent = "Contact information updated!";
        form.appendChild(successMsg);

        // Remove success message after 3 seconds
        setTimeout(() => {
          if (successMsg.parentNode) {
            successMsg.parentNode.removeChild(successMsg);
          }
        }, 3000);
      }

      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const categorySelect = document.getElementById("categorySelect");
        const message = messageInput.value.trim();
        const category = categorySelect.value;

        if (message && stompClient) {
          const chatRequest = {
            type: "MESSAGE",
            chatId: chatId,
            message: message,
            category: category,
            customerName: window.customerName,
            customerEmail: window.customerEmail,
          };

          stompClient.send(
            "/app/chat.sendMessage",
            {},
            JSON.stringify(chatRequest)
          );
          messageInput.value = "";
        }
      }

      function displayMessage(messageData) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";

        if (messageData.type === "CHAT_CREATED") {
          chatId = messageData.chatId;
          messageDiv.className += " system-message";
          messageDiv.textContent = "Chat created: " + messageData.content;
        } else if (messageData.type === "MESSAGE") {
          if (messageData.sender === "USER") {
            messageDiv.className += " user-message";
          } else if (messageData.sender === "AI") {
            messageDiv.className += " ai-message";
          } else if (messageData.sender === "SUPPORT") {
            messageDiv.className += " support-message";
          }
          messageDiv.textContent = messageData.content;
        } else if (messageData.type === "ESCALATION") {
          messageDiv.className += " system-message";
          messageDiv.textContent = messageData.content;
        } else if (messageData.type === "ERROR") {
          messageDiv.className += " error-message";
          messageDiv.textContent = messageData.content;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function loadCategories() {
        fetch("/api/categories")
          .then((response) => response.json())
          .then((categories) => {
            const categorySelect = document.getElementById("categorySelect");
            categorySelect.innerHTML =
              '<option value="">Select a category...</option>';
            categories.forEach((category) => {
              const option = document.createElement("option");
              option.value = category;
              option.textContent = category;
              categorySelect.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading categories:", error);
          });
      }

      // Allow sending message on Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Auto-connect and load categories when page loads
      connect();
      loadCategories();

      // Enable input when connected
      document.getElementById("messageInput").disabled = false;
      document.getElementById("sendButton").disabled = false;
    </script>
  </body>
</html>
