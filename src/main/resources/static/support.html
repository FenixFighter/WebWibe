<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Support Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .dashboard-container {
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .sidebar-header h1 {
        font-size: 20px;
        margin-bottom: 5px;
      }

      .user-info {
        font-size: 14px;
        opacity: 0.9;
      }

      .login-section {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
      }

      .login-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
      }

      .form-group input {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .form-group input:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
      }

      .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #2196f3;
        color: white;
      }

      .btn-primary:hover {
        background: #1976d2;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-warning:hover {
        background: #e0a800;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .chats-section {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
      }

      .chat-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .chat-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .chat-item:hover {
        border-color: #2196f3;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
      }

      .chat-item.active {
        border-color: #2196f3;
        background: #f0f8ff;
      }

      .chat-item.low-rating {
        border-color: #f44336;
        background: #ffebee;
      }

      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .chat-id {
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .chat-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .status-active {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .status-escalated {
        background: #fff3e0;
        color: #f57c00;
      }

      .status-assigned {
        background: #e3f2fd;
        color: #1976d2;
      }

      .customer-info {
        margin-bottom: 8px;
      }

      .customer-name {
        font-weight: 500;
        color: #333;
        font-size: 13px;
      }

      .customer-email {
        color: #666;
        font-size: 12px;
      }

      .chat-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }

      .chat-actions .btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .rating-alert {
        background: #ffebee;
        border: 1px solid #f44336;
        border-radius: 6px;
        padding: 8px;
        margin-top: 8px;
        font-size: 12px;
        color: #c62828;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }

      .chat-container {
        flex: 1;
        display: none;
        flex-direction: column;
      }

      .chat-container.active {
        display: flex;
      }

      .chat-header-main {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .chat-actions-main {
        display: flex;
        gap: 10px;
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.ai {
        justify-content: flex-start;
      }

      .message.support {
        justify-content: flex-start;
      }

      .message.system {
        justify-content: center;
      }

      .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
      }

      .message.user .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.ai .message-bubble {
        background: #e3f2fd;
        color: #1976d2;
        border-bottom-left-radius: 4px;
      }

      .message.support .message-bubble {
        background: #e8f5e8;
        color: #2e7d32;
        border-bottom-left-radius: 4px;
      }

      .message.system .message-bubble {
        background: #fff3e0;
        color: #f57c00;
        border-radius: 18px;
        text-align: center;
        font-style: italic;
      }

      .message-time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 4px;
      }

      .ai-rating {
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        border: 1px solid #e0e0e0;
      }

      .rating-score {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .rating-bar {
        flex: 1;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }

      .rating-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      .rating-fill.excellent {
        background: #4caf50;
      }
      .rating-fill.good {
        background: #8bc34a;
      }
      .rating-fill.fair {
        background: #ffc107;
      }
      .rating-fill.poor {
        background: #ff9800;
      }
      .rating-fill.bad {
        background: #f44336;
      }

      .rating-text {
        font-size: 11px;
        font-weight: 600;
        min-width: 40px;
      }

      .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e0e0e0;
      }

      .input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .message-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 25px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .message-input:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
      }

      .button-row {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .welcome-screen {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #666;
        font-size: 18px;
      }

      .welcome-screen.hidden {
        display: none;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .dashboard-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: 50vh;
        }

        .main-content {
          height: 50vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="sidebar">
        <div class="sidebar-header">
          <h1>Support Dashboard</h1>
          <div id="userInfo" class="user-info" style="display: none">
            Welcome, <span id="userDisplay"></span>
          </div>
        </div>

        <div id="loginSection" class="login-section">
          <form id="loginForm" class="login-form">
            <div class="form-group">
              <label for="username">Username</label>
              <input
                type="text"
                id="username"
                placeholder="Enter username"
                required
              />
            </div>
            <div class="form-group">
              <label for="password">Password</label>
              <input
                type="password"
                id="password"
                placeholder="Enter password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
          </form>
        </div>

        <div id="chatsSection" class="chats-section" style="display: none">
          <div class="section-title">Active Chats</div>
          <div id="chatRoomsList" class="chat-list">
            <!-- Chat rooms will be loaded here -->
          </div>
        </div>
      </div>

      <div class="main-content">
        <div id="welcomeScreen" class="welcome-screen">
          Please select a chat to start supporting customers
        </div>

        <div id="chatContainer" class="chat-container">
          <div class="chat-header-main">
            <div class="chat-title" id="currentChatTitle">Chat</div>
            <div class="chat-actions-main">
              <button
                id="releaseButton"
                class="btn btn-warning"
                onclick="releaseChat()"
                disabled
              >
                Release Chat
              </button>
              <button class="btn btn-secondary" onclick="closeChat()">
                Close
              </button>
            </div>
          </div>

          <div id="chatMessages" class="chat-messages">
            <!-- Messages will be displayed here -->
          </div>

          <div class="chat-input-container">
            <div class="input-row">
              <input
                type="text"
                id="messageInput"
                class="message-input"
                placeholder="Type your message..."
                disabled
              />
            </div>
            <div class="button-row">
              <button id="sendButton" class="btn btn-primary" disabled>
                Send Message
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let stompClient = null;
      let currentUser = null;
      let currentChatId = null;
      let allChats = [];

      // Initialize dashboard
      function initDashboard() {
        setupEventListeners();
      }

      // Setup event listeners
      function setupEventListeners() {
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("messageInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendMessage();
            }
          });
        document
          .getElementById("sendButton")
          .addEventListener("click", sendMessage);
      }

      // Handle login
      async function handleLogin(e) {
        e.preventDefault();

        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok && data.token) {
            currentUser = data;
            showDashboard();
            connectWebSocket();
          } else {
            alert("Login failed: " + (data.message || "Invalid credentials"));
          }
        } catch (error) {
          console.error("Login error:", error);
          alert("Login failed: " + error.message);
        }
      }

      // Show dashboard
      function showDashboard() {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("chatsSection").style.display = "block";
        document.getElementById("userInfo").style.display = "block";
        document.getElementById("userDisplay").textContent =
          currentUser.username;
        loadAssignedChats();
      }

      // Connect to WebSocket
      function connectWebSocket() {
        const socket = new SockJS("/ws/chat");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {},
          function (frame) {
            console.log(
              "Connected to WebSocket as support user:",
              currentUser.username
            );

            // Subscribe to general chat topic for new escalations
            stompClient.subscribe("/topic/chat", onMessageReceived);

            // Subscribe to chat activity notifications
            stompClient.subscribe(
              "/topic/support/activity",
              function (message) {
                const messageData = JSON.parse(message.body);
                console.log("New chat activity:", messageData);
                loadAssignedChats();
              }
            );

            loadAssignedChats();
          },
          function (error) {
            console.error("WebSocket connection error:", error);
          }
        );
      }

      // Load assigned chats
      async function loadAssignedChats() {
        try {
          const response = await fetch("/api/support/all-chats", {
            headers: {
              Authorization: "Bearer " + currentUser.token,
            },
          });

          if (response.ok) {
            allChats = await response.json();
            displayChatRooms(allChats);
          }
        } catch (error) {
          console.error("Error loading all chats:", error);
        }
      }

      // Display chat rooms
      function displayChatRooms(chats) {
        const chatRoomsList = document.getElementById("chatRoomsList");
        chatRoomsList.innerHTML = "";

        chats.forEach((chat) => {
          const roomDiv = document.createElement("div");
          roomDiv.className = "chat-item";
          roomDiv.onclick = () => openChat(chat.chatId);

          const customerInfo =
            chat.customerName || chat.customerEmail
              ? `<div class="customer-info">
                        ${
                          chat.customerName
                            ? `<div class="customer-name">${chat.customerName}</div>`
                            : ""
                        }
                        ${
                          chat.customerEmail
                            ? `<div class="customer-email">${chat.customerEmail}</div>`
                            : ""
                        }
                      </div>`
              : '<div class="customer-info"><div class="customer-name">Anonymous customer</div></div>';

          // Check for low AI ratings
          const hasLowRating = chat.lowRating || false;
          if (hasLowRating) {
            roomDiv.classList.add("low-rating");
          }

          roomDiv.innerHTML = `
                    <div class="chat-header">
                        <div class="chat-id">Chat: ${chat.chatId.substring(
                          0,
                          8
                        )}...</div>
                        <div class="chat-status status-${chat.status.toLowerCase()}">${
            chat.status
          }</div>
                    </div>
                    ${customerInfo}
                    ${
                      hasLowRating
                        ? '<div class="rating-alert">⚠️ Low AI rating - Customer needs attention</div>'
                        : ""
                    }
                    <div class="chat-actions">
                        <button onclick="assignChat('${
                          chat.chatId
                        }')" class="btn btn-success">Assign to Me</button>
                    </div>
                `;

          chatRoomsList.appendChild(roomDiv);
        });
      }

      // Assign chat
      async function assignChat(chatId) {
        try {
          const response = await fetch(`/api/support/assign-chat/${chatId}`, {
            method: "POST",
            headers: {
              Authorization: "Bearer " + currentUser.token,
            },
          });

          if (response.ok) {
            alert("Chat assigned to you successfully!");
            loadAssignedChats();
          } else {
            const errorData = await response.json();
            alert("Error assigning chat: " + errorData.message);
          }
        } catch (error) {
          console.error("Error assigning chat:", error);
          alert("Error assigning chat: " + error.message);
        }
      }

      // Open chat
      async function openChat(chatId) {
        currentChatId = chatId;

        // Update UI
        document.getElementById("welcomeScreen").classList.add("hidden");
        document.getElementById("chatContainer").classList.add("active");
        document.getElementById(
          "currentChatTitle"
        ).textContent = `Chat: ${chatId.substring(0, 8)}...`;
        document.getElementById("messageInput").disabled = false;
        document.getElementById("sendButton").disabled = false;
        document.getElementById("releaseButton").disabled = false;

        // Load chat history
        await loadChatHistory(chatId);

        // Update chat item appearance
        document.querySelectorAll(".chat-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.currentTarget.classList.add("active");
      }

      // Load chat history
      async function loadChatHistory(chatId) {
        try {
          const response = await fetch(`/api/support/chat-history/${chatId}`, {
            headers: {
              Authorization: "Bearer " + currentUser.token,
            },
          });

          if (response.ok) {
            const messages = await response.json();
            displayChatHistory(messages);
          }
        } catch (error) {
          console.error("Error loading chat history:", error);
        }
      }

      // Display chat history
      function displayChatHistory(messages) {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";

        messages.forEach((message) => {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${message.senderType.toLowerCase()}`;

          let ratingHtml = "";
          if (message.senderType === "AI" && message.rating) {
            ratingHtml = createRatingHtml(message.rating);
          }

          messageDiv.innerHTML = `
                    <div class="message-bubble">
                        ${message.content}
                        <div class="message-time">${formatTime(
                          message.createdAt
                        )}</div>
                        ${ratingHtml}
                    </div>
                `;

          chatMessages.appendChild(messageDiv);
        });

        scrollToBottom();
      }

      // Create rating HTML
      function createRatingHtml(rating) {
        const score = rating.score || 0;
        const answer = rating.answer || "";

        let ratingClass = "bad";
        if (score >= 80) ratingClass = "excellent";
        else if (score >= 60) ratingClass = "good";
        else if (score >= 40) ratingClass = "fair";
        else if (score >= 20) ratingClass = "poor";

        return `
                <div class="ai-rating">
                    <div class="rating-score">
                        <span class="rating-text">${score}/100</span>
                        <div class="rating-bar">
                            <div class="rating-fill ${ratingClass}" style="width: ${score}%"></div>
                        </div>
                    </div>
                    ${
                      answer
                        ? `<div style="font-size: 11px; color: #666; margin-top: 4px;">${answer}</div>`
                        : ""
                    }
                </div>
            `;
      }

      // Send message
      function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (message && stompClient && currentChatId) {
          const chatRequest = {
            type: "MESSAGE",
            chatId: currentChatId,
            message: message,
            token: currentUser.token,
          };

          stompClient.send(
            "/app/chat.sendMessage",
            {},
            JSON.stringify(chatRequest)
          );
          messageInput.value = "";
        }
      }

      // Handle received messages
      function onMessageReceived(message) {
        const messageData = JSON.parse(message.body);
        console.log("Received message:", messageData);

        if (currentChatId && messageData.chatId === currentChatId) {
          displayMessage(messageData);
        }
      }

      // Display message
      function displayMessage(messageData) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");

        const senderClass = messageData.sender.toLowerCase();
        messageDiv.className = `message ${senderClass}`;

        let ratingHtml = "";
        if (messageData.sender === "AI" && messageData.rating) {
          ratingHtml = createRatingHtml(messageData.rating);
        }

        messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${messageData.content}
                    <div class="message-time">${formatTime(
                      messageData.timestamp
                    )}</div>
                    ${ratingHtml}
                </div>
            `;

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      // Release chat
      function releaseChat() {
        if (stompClient && currentChatId) {
          const chatRequest = {
            type: "RELEASE",
            chatId: currentChatId,
            token: currentUser.token,
          };

          stompClient.send(
            "/app/chat.release",
            {},
            JSON.stringify(chatRequest)
          );

          // Close the chat
          closeChat();
          alert("Chat released! AI assistant is now available for this chat.");
        }
      }

      // Close chat
      function closeChat() {
        document.getElementById("chatContainer").classList.remove("active");
        document.getElementById("welcomeScreen").classList.remove("hidden");
        document.getElementById("messageInput").disabled = true;
        document.getElementById("sendButton").disabled = true;
        document.getElementById("releaseButton").disabled = true;
        currentChatId = null;
      }

      // Utility functions
      function formatTime(timestamp) {
        if (!timestamp) return "";
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
      }

      function scrollToBottom() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", initDashboard);
    </script>
  </body>
</html>
